#!/bin/bash
# Source common hook utilities
. "$(dirname "$0")/common.sh"

: "${CLIENT_PROFILE:=hmlr}"
: "${API_SERVICE_URL:=http://standard-reports-manager:8080}"
: "${RUN_VARS:=--detach --publish}"

# Initialize branch name
init_branch_name

print_header "Checking \"$BRANCH_NAME\"..."

# Skip on specific branches, with --no-verify flag, or when amending
if should_skip_hook; then
  print_success "Skipping pre-push hook... ðŸŽ‰"
  exit 0
fi

DOCKER_BUILD_EXIT_CODE=0
DOCKER_RUN_EXIT_CODE=0

if ! git update-index -q --ignore-submodules --refresh; then
  print_error "Up-to-date check failed ðŸ˜–"
  DOCKER_BUILD_EXIT_CODE=1
else
  print_warning "Building Docker image with \"$CLIENT_PROFILE\" profile... "
  AWS_PROFILE=$CLIENT_PROFILE make image
  DOCKER_BUILD_EXIT_CODE=$?
fi

if [ $DOCKER_BUILD_EXIT_CODE -ne 0 ]; then
  print_error "Docker image build failed. Please check your changes. ðŸ˜–"
  exit 1
fi

# Build succeeded, now run the container
print_success "Docker image build succeeded. ðŸŽ‰"
CONTAINER_ID=$(make name)
print_warning "Running Docker image $CONTAINER_ID ... "
AWS_PROFILE=$CLIENT_PROFILE API_SERVICE_URL=$API_SERVICE_URL RUN_VARS=$RUN_VARS make run

# Wait for container to stabilize
secs=5
while [ $secs -gt -1 ]; do
  echo -ne "$secs\033[0K\r"
  sleep 1
  : $((secs--))
done

# Check if container is running
docker inspect --format="{{.State.Running}}" "$CONTAINER_ID" | grep 'true' -q
DOCKER_RUN_EXIT_CODE=$?

print_warning "Stopping Docker image with exit code $DOCKER_RUN_EXIT_CODE ... "
make stop

if [ $DOCKER_RUN_EXIT_CODE -ne 0 ]; then
  print_error "Docker image run failed. Please check your changes. ðŸ˜–"
  exit 1
else
  print_success "Docker image run succeeded. ðŸŽ‰"
  exit 0
fi
